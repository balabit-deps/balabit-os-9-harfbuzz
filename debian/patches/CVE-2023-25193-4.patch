Backport of:

From 64fa5cd482d0be2e215998aa1c2a05b978133e7c Mon Sep 17 00:00:00 2001
From: Behdad Esfahbod <behdad@behdad.org>
Date: Tue, 7 Feb 2023 15:50:36 -0700
Subject: [PATCH] [GPOS] Fix assert fail introduced recently

Was introduced in 8708b9e081192786c027bb7f5f23d76dbe5c19e8.

If these lookups are recursed to from (Chain)Context out-of-order,
it was possible that last_base > buffer->idx, in which case we
were attaching marks to a base after them... and an assertion
was failing fortunately.

Fixes https://oss-fuzz.com/testcase-detail/6377756666757120
---
 src/OT/Layout/GPOS/MarkBasePosFormat1.hh          |   5 +++++
 src/OT/Layout/GPOS/MarkLigPosFormat1.hh           |   5 +++++
 ...ase-minimized-hb-shape-fuzzer-6377756666757120 | Bin 0 -> 607 bytes
 3 files changed, 10 insertions(+)
 create mode 100644 test/fuzzing/fonts/clusterfuzz-testcase-minimized-hb-shape-fuzzer-6377756666757120

--- a/src/hb-ot-layout-gpos-table.hh
+++ b/src/hb-ot-layout-gpos-table.hh
@@ -1892,6 +1892,11 @@ struct MarkBasePosFormat1
     hb_ot_apply_context_t::skipping_iterator_t &skippy_iter = c->iter_input;
     skippy_iter.set_lookup_props (LookupFlag::IgnoreMarks);
 
+    if (c->last_base_until > buffer->idx)
+    {
+      c->last_base_until = 0;
+      c->last_base = -1;
+    }
     unsigned j;
     for (j = buffer->idx; j > c->last_base_until; j--)
     {
@@ -2118,6 +2123,11 @@ struct MarkLigPosFormat1
     hb_ot_apply_context_t::skipping_iterator_t &skippy_iter = c->iter_input;
     skippy_iter.set_lookup_props (LookupFlag::IgnoreMarks);
 
+    if (c->last_base_until > buffer->idx)
+    {
+      c->last_base_until = 0;
+      c->last_base = -1;
+    }
     unsigned j;
     for (j = buffer->idx; j > c->last_base_until; j--)
     {
